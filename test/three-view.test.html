<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>three-view test</title>
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../three-view.html">
  <link rel="import" href="../fake-three-model.html">
  <link rel="import" href="../fake-three-controls.html">
  <link rel="import" href="../fake-three-renderer.html">
  <link rel="import" href="../fake-three-scene.html">
</head>
<body>
<test-fixture id="basic">
  <template>
    <three-view
      id="id"
      scene-background-color="#F5F5F2"
      renderer-width="12"
      renderer-height="21">
      <three-model slot="model"></three-model>
    </three-view>
  </template>
</test-fixture>

<script>
  describe('<three-view>', () => {

    let element;

    it('instantiates the element with its default properties', () => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');

      expect(element.localName).to.equal('three-view');
      expect(element.sceneBackgroundColor).to.equal('#F5F5F2');
      expect(element.rendererWidth).to.equal(12);
      expect(element.rendererHeight).to.equal(21);
      expect(element.modelIsReady).to.be.false;
    });

    it('appends the renderer DOM element to the view', () => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');

      expect(element.root.querySelectorAll('canvas')).to.have.lengthOf(1);
    });

    it('calls the renderer once initially', (done) => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        expect(fakeThreeRenderer.renderCount).to.equal(1);

        done();
      });
    });

    it('updates the modelGeometry and renders when the model boundaries change', (done) => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeModel = document.getElementsByTagName('fake-three-model')[0];
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        fakeThreeModel.position = [1, 2, 3];
        fakeThreeModel.radius = 4;

        fakeThreeModel._dispatchModelReady();

        expect(element.modelGeometry).to.deep.equal({position: [1, 2, 3], radius: 4});
        expect(element.modelIsReady).to.be.true;
        expect(fakeThreeRenderer.renderCount).to.equal(2);

        done();
      });
    });

    it('renders when the model says it needs to be rendered', (done) => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeModel = document.getElementsByTagName('fake-three-model')[0];
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        element.modelIsReady = true;
        fakeThreeModel._dispatchModelNeedsRender();

        expect(fakeThreeRenderer.renderCount).to.equal(1);
        done();
      });
    });

    it('does not attempt to render if the model is not ready', (done) => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeModel = document.getElementsByTagName('fake-three-model')[0];
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        fakeThreeModel._dispatchModelNeedsRender();

        expect(fakeThreeRenderer.renderCount).to.equal(0);
        done();
      });
    });

    it('replaces the model in the scene when it gets a new one, and then renders', (done) => {
      replace('three-renderer').with('fake-three-renderer');
      replace('three-controls').with('fake-three-controls');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeScene = element.shadowRoot.querySelector('fake-three-scene');
      const fakeThreeModel = document.getElementsByTagName('fake-three-model')[0];
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        element.modelIsReady = true;
        fakeThreeModel.object = new THREE.Group();

        fakeThreeModel._dispatchNewModel();

        expect(fakeThreeScene.removeCallCount).to.equal(1);
        expect(fakeThreeScene.addCallCount).to.equal(1);
        expect(fakeThreeRenderer.renderCount).to.equal(1);
        done();
      });
    });

    it('does not add the model to the scene if there is nothing to add', () => {
      replace('three-renderer').with('fake-three-renderer');
      replace('three-controls').with('fake-three-controls');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeScene = element.shadowRoot.querySelector('fake-three-scene');
      const fakeThreeModel = document.getElementsByTagName('fake-three-model')[0];

      fakeThreeModel.object = undefined;

      fakeThreeModel._dispatchNewModel();

      expect(fakeThreeScene.addCallCount).to.equal(0);
    });

    it('only calls the renderer once when the controls change multiple times in close succession', (done) => {
      replace('three-controls').with('fake-three-controls');
      replace('three-renderer').with('fake-three-renderer');
      replace('three-model').with('fake-three-model');
      replace('three-scene').with('fake-three-scene');
      element = fixture('basic');
      const fakeThreeControls = element.shadowRoot.querySelector('fake-three-controls');
      const fakeThreeRenderer = element.shadowRoot.querySelector('fake-three-renderer');
      flush(() => {
        element.modelIsReady = true;

        fakeThreeControls._dispatchModelNeedsRender();
        fakeThreeControls._dispatchModelNeedsRender();
        fakeThreeControls._dispatchModelNeedsRender();

        expect(fakeThreeRenderer.renderCount).to.equal(1);
        done();
      });
    });
  });
</script>
</body>
</html>