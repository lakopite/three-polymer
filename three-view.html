<script src="bower_components/threejs/build/three.min.js"></script>
<script src="bower_components/threejs/examples/js/controls/OrbitControls.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="three-camera.html">
<link rel="import" href="three-helpers.html">

<!--
`three-view`
@demo demo/index.html
-->

<dom-module id="three-view">
  <template>
    <three-camera
      object="{{camera}}"
      position="{{cameraPosition}}"
      focal-point="{{cameraFocalPoint}}">
    </three-camera>
    <slot id="latticeSlot" name="lattice"></slot>
  </template>
  <script>
    class ThreeView extends Polymer.Element {

      static get is() {
        return 'three-view';
      }

      static get properties() {
        return {
          width: {type: Number, observer: '_sizeChanged'},
          height: {type: Number, observer: '_sizeChanged'},
          backgroundColor: {type: String, observer: '_backgroundColorChanged'},
          camera: {type: Object, observer: '_cameraChanged'},
          cameraPosition: Array,
          cameraFocalPoint: Array,
          mesh: Object,
          scene: {type: Object, value: new THREE.Scene()},
          renderer: {type: Object, value: new THREE.WebGLRenderer({antialias: true})},
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('three-lattice-changed', () => this.handleThreeLatticeChanged());
        this.addEventListener('three-lattice-connected', e => this.handleThreeLatticeConnected(e));
        this.root.appendChild(this.renderer.domElement);
      }

      render() {
        if (this.camera && this.mesh) {
          this.renderer.render(this.scene, this.camera);
        } else console.log('no camera or mesh, so no render');
      }

      controlsChanged() {
        this.render();
      }

      _sizeChanged() {
        this.renderer.setSize(this.width, this.height);
      }

      _backgroundColorChanged() {
        this.scene.background = new THREE.Color().setStyle(this.backgroundColor);
      }

      _cameraChanged() {
        console.log("_cameraChanged");
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.addEventListener('change', e => this.controlsChanged());
      };

      handleThreeLatticeConnected(e) {
        console.log("handleThreeLatticeConnected");
        this.mesh = e.detail.object;
        this.scene.add(this.mesh);
      }

      handleThreeLatticeChanged() {
        console.log("handleThreeLatticeChanged");
        this.moveCamera();
        this.render();
      }

      moveCamera() {
        this.cameraPosition = [
          this.mesh.geometry.boundingSphere.center.x,
          this.mesh.geometry.boundingSphere.radius * -2.5,
          this.mesh.geometry.boundingSphere.center.z
        ];
        this.cameraFocalPoint = this.mesh.geometry.boundingSphere.center.toArray();
      }
    }

    customElements.define(ThreeView.is, ThreeView);
  </script>
</dom-module>
