<script src="../threejs/build/three.min.js"></script>
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="three-camera.html">
<link rel="import" href="three-stats.html">
<link rel="import" href="three-controls.html">
<link rel="import" href="three-renderer.html">
<link rel="import" href="three-scene.html">

<!--
`three-view`
@demo demo/index.html
-->

<dom-module id="three-view">
  <template>
    <three-stats
      id="stats"
      show-stats="[[showStats]]">
    </three-stats>
    <three-controls
      id="controls"
      camera="{{camera}}"
      canvas="[[canvas]]"
      camera-position="[[cameraPosition]]"
      model-geometry="[[modelGeometry]]">
    </three-controls>
    <three-renderer
      id="renderer"
      canvas="{{canvas}}"
      camera="[[camera]]"
      scene="[[scene]]"
      width="[[rendererWidth]]"
      height="[[rendererHeight]]">
    </three-renderer>
    <three-scene
      id="scene"
      object="{{scene}}"
      background-color="[[sceneBackgroundColor]]">
    </three-scene>
    <slot
      id="modelSlot"
      name="model">
    </slot>
  </template>
  <script>
    class ThreeView extends Polymer.Element {

      static get is() {
        return 'three-view';
      }

      static get properties() {
        return {
          camera: Object,
          scene: Object,
          sceneBackgroundColor: String,
          model: Object,
          modelRadius: Number,
          modelPosition: Array,
          modelGeometry: Object,
          rendererWidth: Number,
          rendererHeight: Number,
          canvas: {type: Object, observer: '_canvasChanged'},
          showStats: {type: Boolean, value: false},
          modelIsReady: {type: Boolean, value: false},
          initialRenderIsComplete: {type: Boolean, value: false},
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('new-model', e => this._handleNewModel(e));
        this.addEventListener('model-ready', e => this._handleModelReady(e));
        this.addEventListener('model-needs-render', () => this._handleModelNeedsRender());
      }

      _render() {
        if (!this.modelIsReady && this.initialRenderIsComplete) return;
        this._debouncer = Polymer.Debouncer.debounce(
          this._debouncer,
          Polymer.Async.animationFrame,
          () => {
            console.log('_render');
            this.$.stats.update();
            this.$.renderer.render();
            this.initialRenderIsComplete = true;
          });
      }

      _canvasChanged(newCanvas) {
        this.root.appendChild(newCanvas);
      }

      _handleNewModel(event) {
        this.model = event.target.object;
        const scene = this.$.scene;
        scene.removeAllObjects();
        if (this.model === undefined) return;
        scene.addObject(this.model);
        this._render();
      }

      _handleModelReady(event) {
        console.log('_handleModelReady');
        this.modelGeometry = {
          position: event.target.position,
          radius: event.target.radius,
        };
        this.modelIsReady = true;
        this._render();
      }

      _handleModelNeedsRender() {
        this._render();
      }
    }

    customElements.define(ThreeView.is, ThreeView);
  </script>
</dom-module>
