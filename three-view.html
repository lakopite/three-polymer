<script src="bower_components/threejs/build/three.min.js"></script>
<script src="bower_components/stats.js/build/stats.min.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="three-camera.html">
<link rel="import" href="three-controls.html">
<link rel="import" href="three-renderer.html">
<link rel="import" href="three-scene.html">

<!--
`three-view`
@demo demo/index.html
-->

<dom-module id="three-view">
  <template>
    <div id="stats"></div>
    <three-controls
      id="controls"
      camera="{{camera}}"
      canvas="[[canvas]]"
      camera-position="[[cameraPosition]]"
      camera-target="[[geometryPosition]]"
      geometry-radius="[[geometryRadius]]">
    </three-controls>
    <three-renderer
      id="renderer"
      canvas="{{canvas}}"
      camera="[[camera]]"
      scene="[[scene]]"
      width="[[rendererWidth]]"
      height="[[rendererHeight]]">
    </three-renderer>
    <three-scene
      id="scene"
      object="{{scene}}"
      background-color="[[sceneBackgroundColor]]">
    </three-scene>
    <slot id="latticeSlot" name="lattice"></slot>
  </template>
  <script>
    class ThreeView extends Polymer.Element {

      static get is() {
        return 'three-view';
      }

      static get properties() {
        return {
          rendererWidth: Number,
          rendererHeight: Number,
          sceneBackgroundColor: String,
          scene: Object,
          camera: Object,
          geometryRadius: Number,
          geometryPosition: Array,
          canvas: {type: Object, observer: '_canvasChanged'},
          showStats: {type: Boolean, value: false},
          stats: {
            type: Object,
            computed: '_computeStats(showStats)',
            observer: '_statsChanged',
          },
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('lattice-changed', e => this._handleLatticeChanged(e.detail));
        this.addEventListener('lattice-geometry-changed', e => this._handleLatticeGeometryChanged(e.detail));
        this.addEventListener('controls-changed', () => this._handleControlsChanged());
        this._render();
      }

      _render() {
//        console.log('_render');
        if (this.stats) this.stats.update();
        this.$.renderer.render();
      }

      _computeStats(showStats) {
        if (!showStats) return;
        const stats = new Stats();
        stats.setMode(0);
        stats.dom.style.position = 'relative';
        stats.dom.style.left = '0px';
        stats.dom.style.top = '0px';
        return stats;
      }

      _statsChanged(newStats) {
        this.$.stats.appendChild(newStats.dom);
      }

      _canvasChanged(newCanvas, oldCanvas) {
        this.root.appendChild(newCanvas);
      }

      _handleControlsChanged() {
        this._render();
      };

      _handleLatticeChanged(lattice) {
//        console.log("_handleLatticeChanged");
        const scene = this.$.scene;
        scene.removeAllObjects();
        if (lattice.object) scene.addObject(lattice.object);
        this._render();
      }

      _handleLatticeGeometryChanged(lattice) {
//        console.log("_handleLatticeGeometryChanged");
        this.geometryPosition = lattice.geometryCenter;
        this.geometryRadius = lattice.geometryRadius;
        this._render();
      }
    }

    customElements.define(ThreeView.is, ThreeView);
  </script>
</dom-module>
