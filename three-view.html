<script src="bower_components/threejs/build/three.min.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="three-camera.html">
<link rel="import" href="three-controls.html">
<link rel="import" href="three-renderer.html">

<!--
`three-view`
@demo demo/index.html
-->

<dom-module id="three-view">
  <template>
    <three-controls
      camera="{{camera}}"
      canvas="{{canvas}}">
    </three-controls>
    <three-camera
      object="{{camera}}"
      position="{{cameraPosition}}"
      focal-point="{{cameraFocalPoint}}">
    </three-camera>
    <three-renderer
      id="renderer"
      camera="{{camera}}"
      scene="{{scene}}"
      canvas="{{canvas}}"
      width="{{rendererWidth}}"
      height="{{rendererHeight}}">
    </three-renderer>
    <slot id="latticeSlot" name="lattice"></slot>
  </template>
  <script>
    class ThreeView extends Polymer.Element {

      static get is() {
        return 'three-view';
      }

      static get properties() {
        return {
          rendererWidth: Number,
          rendererHeight: Number,
          backgroundColor: {type: String, observer: '_backgroundColorChanged'},
          camera: Object,
          cameraPosition: Array,
          cameraFocalPoint: Array,
          mesh: Object,
          scene: {type: Object, value: new THREE.Scene()},
          canvas: {type: Object, observer: '_canvasChanged'},
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('lattice-connected', e => this.handleLatticeConnected(e.detail));
        this.addEventListener('lattice-geometry-changed', e => this.handleLatticeGeometryChanged(e.detail));
        this.addEventListener('controls-changed', () => this.handleControlsChanged());
      }

      render() {
        this.$.renderer.render();
      }

      updateCamera(geometryCenter, geometryRadius) {
        this.cameraPosition = [geometryCenter[0], geometryRadius * -2.5, geometryCenter[2]];
        this.cameraFocalPoint = geometryCenter
      }

      _canvasChanged(newCanvas, oldCanvas) {
        this.root.appendChild(newCanvas);
      }

      _backgroundColorChanged(newBackgroundColor, oldBackgroundColor) {
        this.scene.background = new THREE.Color().setStyle(newBackgroundColor);
      }

      handleControlsChanged() {
        this.render();
      };

      handleLatticeConnected(lattice) {
        console.log("handleLatticeConnected");
        this.mesh = lattice.object;
        this.scene.add(this.mesh);
      }

      handleLatticeGeometryChanged(lattice) {
        console.log("handleLatticeGeometryChanged");
        this.updateCamera(lattice.geometryCenter, lattice.geometryRadius);
        this.render();
      }
    }

    customElements.define(ThreeView.is, ThreeView);
  </script>
</dom-module>
