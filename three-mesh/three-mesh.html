<link rel="import" href="abstract-three-mesh.html">
<link rel="import" href="../three-material/three-material.html">
<link rel="import" href="../three-line-geometry/three-line-geometry.html">

<dom-module id="three-mesh">
  <template>
    <three-line-geometry
      stroke="[[stroke]]"
      vertices="[[vertices]]"
      object="{{geometry}}">
    </three-line-geometry>
    <three-material id="material" object="{{material}}" color="[[color]]"></three-material>
  </template>
  <script>
    class ThreeMesh extends AbstractThreeMesh {

      static get is() {
        return 'three-mesh';
      }

      static get properties() {
        return {
          contourColorLimits: Array,
          contourColors: Array,
          contourBy: String,
          metadata: Object,
          vertices: Array,
          color: {
            type: String,
            readOnly: true,
            observer: '_dispatchMeshChange',
            computed: '_computeColor(contourColorLimits, contourColors, contourBy, metadata)',
          },
          geometry: {type: Object, observer: '_geometryChanged'},
          material: {type: Object, observer: '_materialChanged'},
          object: {
            type: Object,
            value: () => new THREE.Mesh(),
            observer: '_dispatchNewMesh',
          },
          stroke: Number,
        }
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._dispatchRemoveMesh();
      }

      _computeColor(contourColorLimits, contourColors, contourBy, metadata) {
        if (!(contourColorLimits && contourColors && contourBy && metadata)) return;

        const maximumColor = contourColors[contourColors.length - 1];
        const index = contourColorLimits.findIndex(contourValue => metadata[contourBy] <= contourValue);

        return index === -1 ? maximumColor : contourColors[index];
      }

      _geometryChanged(geometry) {
        this.object.geometry = geometry;
        this._dispatchMeshChange();
      }

      _materialChanged(material) {
        this.object.material = material;
        this._dispatchMeshChange();
      }
    }

    customElements.define(ThreeMesh.is, ThreeMesh);
  </script>
</dom-module>