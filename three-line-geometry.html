<script src="/bower_components/lodash/lodash.js"></script>
<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="three-object.html">

<dom-module id="three-line-geometry">
  <script>
    class ThreeLineGeometry extends ThreeObject {

      static get is() {
        return 'three-line-geometry';
      }

      // TODO: deal with other camera normals
      static get properties() {
        return {
          cameraNormal: {type: Array, value: [0, 1, 0]},
          stroke: {type: Number, value: 2},
          vertices: {type: Array, observer: "_verticesChanged"},
          contourValues: Array,
          contourColors: Array,
          contourBy: String,
          result: Number,
          object: {type: Object, value: new THREE.Geometry()}
        }
      }

      // TODO: garbage collection?
      connectedCallback() {
        super.connectedCallback();

        const v0 = new THREE.Vector3(...this.vertices[0]);
        const v1 = new THREE.Vector3(...this.vertices[1]);
        const centerLineVector = v1.clone().sub(v0).normalize();
        const cameraNormalVector = new THREE.Vector3(...this.cameraNormal).normalize();
        const centerLineNormalVector = centerLineVector.clone().applyAxisAngle(cameraNormalVector, Math.PI / 2);

        const v0l = v0.clone().addScaledVector(centerLineNormalVector, this.stroke / 2);
        const v0r = v0.clone().addScaledVector(centerLineNormalVector, -1 * this.stroke / 2);
        const v1l = v1.clone().addScaledVector(centerLineNormalVector, this.stroke / 2);
        const v1r = v1.clone().addScaledVector(centerLineNormalVector, -1 * this.stroke / 2);

        let contourValue = this.getContourValue(this.contourValues, this.contourColors, this.result[this.contourBy]);
        const color = new THREE.Color().setStyle(contourValue);
        const geometry = new THREE.Geometry();
        geometry.vertices.push(v0l);
        geometry.vertices.push(v0r);
        geometry.vertices.push(v1r);
        geometry.vertices.push(v1l);
        geometry.faces.push(new THREE.Face3(0, 1, 2, cameraNormalVector, color));
        geometry.faces.push(new THREE.Face3(0, 2, 3, cameraNormalVector, color));
        this.object = geometry;
      }

      _verticesChanged() {
        this.object.computeBoundingSphere();
      }

      getContourValue(contourValues, contourColors, value) {
        return contourColors[contourValues.findIndex((contourValue) => {return value <= contourValue})];
      }
    }

    customElements.define(ThreeLineGeometry.is, ThreeLineGeometry);
  </script>
</dom-module>