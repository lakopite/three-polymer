<script src="bower_components/lodash/lodash.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">

<dom-module id="three-line-geometry">
  <script>
    class ThreeLineGeometry extends Polymer.Element {

      static get is() {
        return 'three-line-geometry';
      }

      static get properties() {
        return {
          cameraNormal: {type: Array, value: [0, 1, 0]},
          stroke: {type: Number, value: 2},
          vertices: Array,
          contourValues: Array,
          contourColors: Array,
          contourBy: String,
          metadata: Object,
          color: {
            type: String,
            readOnly: true,
            computed: "_computeColor(contourValues, contourColors, contourBy, metadata)"
          },
          object: {
            type: Object,
            observer: '_objectChanged',
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this._calculateObject();
      }

      _calculateObject() {
        const v0 = new THREE.Vector3(...this.vertices[0]);
        const v1 = new THREE.Vector3(...this.vertices[1]);
        const centerLineVector = v1.clone().sub(v0).normalize();
        const cameraNormalVector = new THREE.Vector3(...this.cameraNormal).normalize();
        const centerLineNormalVector = centerLineVector.clone().applyAxisAngle(cameraNormalVector, Math.PI / 2);

        const v0l = v0.clone().addScaledVector(centerLineNormalVector, this.stroke / 2);
        const v0r = v0.clone().addScaledVector(centerLineNormalVector, -1 * this.stroke / 2);
        const v1l = v1.clone().addScaledVector(centerLineNormalVector, this.stroke / 2);
        const v1r = v1.clone().addScaledVector(centerLineNormalVector, -1 * this.stroke / 2);

        const geometry = new THREE.Geometry();
        geometry.vertices.push(v0l);
        geometry.vertices.push(v0r);
        geometry.vertices.push(v1r);
        geometry.vertices.push(v1l);
        geometry.faces.push(new THREE.Face3(0, 1, 2, cameraNormalVector, new THREE.Color().setStyle(this.color)));
        geometry.faces.push(new THREE.Face3(0, 2, 3, cameraNormalVector, new THREE.Color().setStyle(this.color)));
        this.object = geometry;
      }

      _objectChanged() {
        const eventInitDict = {bubbles: true, composed: true, detail: this.object};
        let customEvent = new CustomEvent('three-line-geometry-ready', eventInitDict);
        this.dispatchEvent(customEvent);
      }

      _computeColor(contourValues, contourColors, contourBy, metadata) {
        const index = contourValues.findIndex((contourValue) => {
          return metadata[contourBy] <= contourValue
        });
        return contourColors[index];
      }
    }

    customElements.define(ThreeLineGeometry.is, ThreeLineGeometry);
  </script>
</dom-module>