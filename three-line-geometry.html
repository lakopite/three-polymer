<script src="../lodash/lodash.js"></script>
<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="three-line-geometry">
  <script>
    class ThreeLineGeometry extends Polymer.Element {

      static get is() {
        return 'three-line-geometry';
      }

      static get properties() {
        return {
          cameraNormal: {type: Array, value: [0, 1, 0]},
          stroke: {type: Number, value: 1},
          vertices: Array,
          object: {
            type: Object,
            computed: '_computeGeometry(vertices, cameraNormal, stroke)',
            notify: true,
          },
          midpoint: {type: Array, computed: '_computeMidpoint(vertices)'},
        }
      }

      _computeGeometry(vertices, cameraNormal, stroke) {
        if (!(vertices && cameraNormal && stroke)) return;
//        console.log("_computeGeometry with midpoint:", this._computeMidpoint(vertices), "stroke:", stroke);
        const v0 = new THREE.Vector3(...vertices[0]);
        const v1 = new THREE.Vector3(...vertices[1]);
        const centerLineVector = v1.clone().sub(v0).normalize();
        const cameraNormalVector = new THREE.Vector3(...cameraNormal).normalize();
        const centerLineNormalVector = centerLineVector.clone().applyAxisAngle(cameraNormalVector, Math.PI / 2);

        const v0l = v0.clone().addScaledVector(centerLineNormalVector, stroke / 2);
        const v0r = v0.clone().addScaledVector(centerLineNormalVector, -1 * stroke / 2);
        const v1l = v1.clone().addScaledVector(centerLineNormalVector, stroke / 2);
        const v1r = v1.clone().addScaledVector(centerLineNormalVector, -1 * stroke / 2);

        const geometry = new THREE.Geometry();
        geometry.vertices.push(v0l, v0r, v1r, v1l);

        geometry.faces.push(
          new THREE.Face3(0, 1, 2, cameraNormalVector),
          new THREE.Face3(0, 2, 3, cameraNormalVector)
        );

        return geometry;
      }

      _computeMidpoint(vertices) {
        return _.zipWith(vertices[0], vertices[1], (c0, c1) => (c0 + c1) / 2);
      }
    }

    customElements.define(ThreeLineGeometry.is, ThreeLineGeometry);
  </script>
</dom-module>