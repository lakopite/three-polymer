<script src="../../lodash/lodash.js"></script>
<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="three-string-contour.html">
<link rel="import" href="three-numeric-contour.html">

<dom-module id="three-contour">
  <template>
    <template is="dom-if" if="{{valueTypeIsString}}">
      <three-string-contour
        ordered-value-set="[[orderedValueSet]]"
        default-colors="[[defaultColors]]"
        colors="{{colors}}"
        color-limits="{{colorLimits}}">
      </three-string-contour>
    </template>
    <template is="dom-if" if="{{!valueTypeIsString}}">
      <three-numeric-contour
        bounds="[[numericBounds]]"
        default-colors="[[defaultColors]]"
        colors="{{colors}}"
        color-limits="{{colorLimits}}">
      </three-numeric-contour>
    </template>
  </template>
  <script>
    class ThreeContour extends Polymer.Element {

      static get is() {
        return 'three-contour';
      }

      static get properties() {
        return {
          data: Array,
          by: String,
          valueTypeIsString: {type: Boolean, computed: '_computeValueTypeIsString(data, by)'},
          stringValueSet: {type: Array},
          orderedValueSet: {
            type: Array,
            computed: '_computeOrderedValueSet(data, by)',
            observer: '_orderedValueSetChanged'
          },
          colors: {type: Array, notify: true},
          defaultColors: {
            type: Array,
            readOnly: true,
            value: ["#9C27B0", "#673AB7", "#3F51B5", "#2196F3", "#00BCD4", "#009688",
              "#4CAF50", "#8BC34A", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#F44336"]
          },
          numericBounds: {type: Object, notify: true},
          colorLimits: {type: Array, notify: true},
        }
      }

      _computeValueTypeIsString(data, by) {
        if (!Array.isArray(data) || data.length === 0) return;

        return typeof(data[0].metadata[by]) === "string";
      }

      _computeOrderedValueSet(data, by) {
        if (!Array.isArray(data) || data.length === 0) return;
        return data
          .map(line => line.metadata[by])
          .reduce((valueSet, value) => {
            const findIndexResult = valueSet.findIndex(existingValue => value < existingValue);
            const indexToSpliceInto = findIndexResult === -1 ? valueSet.length : findIndexResult;

            const valueIsNotAlreadyInSet = !(valueSet[indexToSpliceInto - 1] === value);
            if (valueIsNotAlreadyInSet) valueSet.splice(indexToSpliceInto, 0, value);

            return valueSet;
          }, []);
      }

      _orderedValueSetChanged(orderedValueSet) {

        this.numericBounds = orderedValueSet
          ? {min: orderedValueSet[0], max: orderedValueSet[orderedValueSet.length - 1]}
          : undefined;
      }
    }

    customElements.define(ThreeContour.is, ThreeContour);
  </script>
</dom-module>