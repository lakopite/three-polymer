<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="three-line-geometry.html">

<dom-module id="three-geometry">
  <template>
    <template id="geometry" is="dom-repeat" items="{{data}}" as="line" initial-count="1">
      <three-line-geometry
        on-three-line-geometry-changed="_handleLineGeometryChanged"
        vertices="{{line.vertices}}"
        metadata="{{line.metadata}}"
        stroke="[[stroke]]"
        contour-by="{{contourBy}}"
        contour-values="{{contourValues}}"
        contour-colors="{{contourColors}}">
      </three-line-geometry>
    </template>
  </template>
  <script>
    class ThreeGeometry extends Polymer.Element {

      static get is() {
        return 'three-geometry';
      }

      static get properties() {
        return {
          data: {type: Array, observer: '_dataChanged'},
          center: {type: Array, notify: true},
          radius: {type: Number, notify: true},
          stroke: Number,
          contourBy: String,
          contourColors: {
            type: Array,
            readOnly: true,
            value: [
              "#9C27B0",
              "#673AB7",
              "#3F51B5",
              "#2196F3",
              "#00BCD4",
              "#009688",
              "#4CAF50",
              "#8BC34A",
              "#FFEB3B",
              "#FFC107",
              "#FF9800",
              "#FF5722",
              "#F44336"
            ]
          },
          contourValues: {type: Array, computed: '_computeContourValues(contourBy, data)'},
          object: {type: Object, notify: true},
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('dom-change', () => this._updateStroke());
      }

      _updateStroke() {
        if (!this._linesAreDoneRendering() || !this.radius) return;
        this.stroke = this.radius / 10;
      }

      _linesAreDoneRendering() {
        return (this.$.geometry.items.length === this.$.geometry.renderedItemCount);
      }

      _dataChanged(newData, oldData) {
//        console.log('_dataChanged to:', newData);
        this.object = new THREE.Geometry();
      }

      _computeContourValues(contourBy, data) {
        const length = this.contourColors.length;
        const values = _.map(data, (line) => {return line.metadata[contourBy]});

        if (values.length === 1) return new Array(length).fill(values[0]);

        const max = _.max(values);
        const min = _.min(values);
        const step = (max - min) / length;
        let contourValues = _.rangeRight(max, min, -step)
          .map((it) => {return _.round(it, 4)});

        if (contourValues.length === 14) contourValues = _.drop(contourValues);

        return contourValues;
      }

      _handleLineGeometryChanged(e) {
//        console.log("_handleLineGeometryChanged");
        const geometry = e.detail;
        if (!geometry) return;
        this.object.merge(geometry);
        this.object.elementsNeedUpdate = true;
        this.object.computeBoundingSphere();
        this.radius = this.object.boundingSphere.radius;
        this.center = this.object.boundingSphere.center.toArray();
      }
    }

    customElements.define(ThreeGeometry.is, ThreeGeometry);
  </script>
</dom-module>